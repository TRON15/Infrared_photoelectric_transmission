# __电度表数字光电传送__

参与者：刘心志 蔡志军 李朝鉴

## 题目描述

### 1.基本要求

> + 1）采用光电数字传送方式（Finished）
> + 2）将电度表表盘转动圈数转化为数字量，用计数器进行记录（Finished）
> + 3）电度表能接受抄表员发出的用电数据读取指令（Finished）
> + 4）电度表在收到读取指令后，将电度表用电数据传送并显示在人端的接收（Finished）

### 2.设计内容

> + 1）计数：设计计数电路，记录电度表表盘转动圈数（Finished）
> + 2）编码：将计数器记录的数字量转换为对应的数字脉冲（Finished）
> + 3）译码与时间协调：红外光发射与接收电路设计(Finished)
> + 4）显示：用户端显示与按钮交互设计(Finished)

## 题意理解

### 1.模块划分

#### 电表端：

> + 1）电表计数显示模块：

```
输入：电度表光电传感器产生的计数方波
输出：数码管实时显示/数据载入移位寄存器并行输入端
技术路线：逻辑门二值化滤波->可重复触发单稳滤波->计数器实时计数->BCD-7段译码器/移位寄存器并行输入
```

> + 2）电表端通信模块

```
输入：计数器并行输出/请求数据标志/收发数据状态位
输出：TX发送编码后串行64位数据/收发数据状态位
技术路线：收到请求数据标志->根据信号时长判断->收发状态数据位翻转->移位寄存器串行输出->4*4位二进制数编码为4*4*4位二进制->加入载波发送->发送完毕收发数据位翻转
```

#### 用户端：
> + 1）用户端显示模块

```
输入：收发状态数据位/寄存器并行输出
输出：接收完毕后数码管显示
技术路线：收发数据状态位翻转->数码管使能显示
```

> + 2) 用户端通信模块

```
输入：接受到4*4*4位信号/收发数据状态位/按钮延时方波信号
输出：收发数据状态位/寄存器并行输出
技术路线：按钮延时方波信号->收发数据状态位翻转/数码管显示关闭使能->4*4*4位二进制数据译码为4*4位数据->寄存器并行输出->收发数据状态位翻转/数码管显示使能
```

> + 3）用户端自动交互模块

```
输入：按键按下弹起原始信号
输出：延时后的方波信号
技术路线：按键动作信号->电容延时充放电->单稳整形->单稳延时触发方波信号
```

### 2.通信协议

> + 1）实现方式概述

根据在作品完成后与老师的交流中得知，往届学生的作品主要采取以下三种编码方式：

_a)数据-波数直接相关型：_

当电表端接受到发送数据请求后，将当前用电数根据高频信源每次减一，同时通
过红外二极管发送一个脉冲，用户端收到一个脉冲后就在显示上加一，当电表端计数减
至零，发波停止，用户端在一定时间内没收到脉冲则认为传送结束。


```
优点：实现简单
缺点：发送时间和数据数值大小正相关，等待时间不确定；扩展性不强；抗干扰能力弱
```
_b)同步通信型_

当电表端接受到发送数据请求后，电表端高频时钟源分频得到低频信号控制发送
用电数的二进制，用户端收到信号，同频低频信号开始工作，同步接受二进制数据。其
余与数据-波数直接相关型相似。

```
优点：实现简单，比数据-波数直接相关型稳定
缺点：时钟源难以调到同频
```

_c)异步通信编码型_

将信号进行编码，标准格式包括包头/数据/校验位，当电表端接收到发送请求
后，将要发送的数据进行编码，用户端收到特点包头后开始解码，完成校验后收发完
毕。

```
优点：准确率高/两侧时钟可不同频/扩展性强/抗干扰能力强
缺点：实现复杂
```

> + 2）本项目实现方式

以上三种实现方式本项目均有考虑过，数据-波数直接相关型/同步通信型，实现较为简
单，而异步通信型虽然实现复杂但更稳定/扩展性更强。考虑到本项目传输的数据只有16
位二进制数据，我们在标准的异步通信实现方式上进行了改进，去掉了校验位，将包头
包含在了每个二进制数据之前，通过电路中必须实现的数据位数计数来校验。虽然在时
间上进行了一定牺牲，但使用了更少的芯片达到了同样稳定的效果。

具体编码/译码实现方式如下

_编码：_

```
0 - 0100
1 - 0111
```

![encode](https://raw.githubusercontent.com/TRON15/MarkdownPhotos/master/encode.PNG)

01为每个二进制数据的包头，利用其中的上升沿触发译码电路工作

_译码：_

在发送请求数据指令后，等待数据，收到上升沿后，间隔一定时间（四位编码中的第二
位结束和第四位结束之间）查看信号，为高电平则译为1/为低电平译为0

![decode](https://raw.githubusercontent.com/TRON15/MarkdownPhotos/master/decode.PNG)

原理图：

![decode&encode](https://raw.githubusercontent.com/TRON15/MarkdownPhotos/master/encode%26decode.PNG)

## 功能实现

分为电表端和用户端两个独立模块，具体原理图与仿真详见 用户端.ms12/电表端.ms12

电表端电表计数显示模块 ——实现基本要求 2）
电表端原始信号编码与红外发送电路-CZJ
电表端表端通信模块——实现基本要求 1）/3）/额外功能：信号结束自锁进程电路-LXZ
用户端接收红外信号脉冲整形相关控制电路-LCJ
用户端通信模块——实现基本要求 1）/额外功能：信号丢失校验与重启电路-CZJ
用户端接收红外信号脉冲整形相关控制电路-LCJ
用户端通信模块——实现基本要求 1）/额外功能：信号丢失校验与重启电路-CZJ
用户端信号解码、显示电路-LCJ
用户端显示模块——实现基本要求 4）/额外功能：状态提示电路（工作状态提示、按键无效
提示、数据无效提示）-LXZ
用户端信号解码、显示电路-LCJ
用户端请求信号发送电路-????
用户端状态转换电路（发请求信号-待接收状态-接收状态-显示状态）-LCJ
电表端接受请求信号与识别电路-CZJ
电表端状态转换电路（收请求信号-发送信号-结束发送信号-下一次待接受请求信号） -LXZ
